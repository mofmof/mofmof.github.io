---
layout: blog
title: "[Rails] devise の使い方（Validatable Recoverable Rememberable）"
category: blog
tags: [Rails, devise, gem,]
summary: deviseを使いこなすためには、各モジュールの提供してくれるメソッドを理解し適切な使用をしなくてはいけません。Validatable Recoverable, Rememberableで使用できるメソッドについて解説していきます。
author: akito-n
#image: none
---

# Deviseの使い方（各種オプション編2）

devise gemはモジュールの概念に基づいて作成されています。

[devise](https://github.com/heartcombo/devise)

この性質のおかげで開発者は自分のアプリに本当に必要なものだけをピンポイントに導入することが可能です。使用していないコードをアプリに組み込まずに済むのは可読性の面からとてもありがたいですね。

※ここではマッピングされたモデルはUserであると仮定して話を進めていきます。

※また、Deviseはwardenという認証の仕組みをベースに採用していますが、今回Wardenについては深く触れません。

[warden](https://github.com/wardencommunity/warden)gemはこちら


## 目次
- [Confirmable](#anc1)

- [Lockable](#anc2)

- [Timeoutable](#anc3)

- [Trackable](#anc4)

# 各種モジュール

Deviseは大きく10のモジュールから構成されています。


1. Database Authenticatable
2. Registerable
3. Validatable
4. Recoverable
5. Rememberable
6. [Confirmable](#anc1)
7. [Lockable](#anc2)
8. [Timeoutable](#anc3)
9. [Trackable](#anc4)
10. Omniauthable


<a id="anc1"></a>

# Confirmable

認証済みのログインかどうかを確認すること、新規登録時に確認の署名付きのメール送信、あるいは手動で確認メールのリクエストが行われたときに対する対応を行う。

confirmableを最大限に利用するためには
```
confirmation_token
confirmed_at
confirmation_sent_at
unconfirmed_email
```

の４つのカラムが必要になる。

インスタンスメソッド

## **active_for_authentication?** ⇒ Boolean
呼び出し元のインスタンスがアクティブなサインイン状態かどうかを確認する。戻り値はBool

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L144){:target="_blank"}

```
def active_for_authentication?
  super && (!confirmation_required? || confirmed? || confirmation_period_valid?)
end
```
後半は未確認状態であり、または確認メールの有効期限が切れているかを確認している。端的に言うとcomfirmed_atの値がnilじゃなければ必ず戻り値はtrueになる。

## **after_confirmation** ⇒ Object (protected)
認証が行われた際にコールバックとして呼ばれる。例えば認証後に独自の処理を行う場合にこのメソッド内に実装する。
デフォルトの定義内には何も記載はない。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L329){:target="_blank"}

```
def after_confirmation
end
```

## **confirm(args = {})** ⇒ Object
認証されていない場合はconfirmed_atを現在の時刻で更新する。もし認証済みであればemailのフィールドに認証済みであるという旨のエラーを追加する。ユーザーが無効の場合はその旨のエラーメッセージをさらに追加する。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L79){:target="_blank"}

```
def confirm(args={})
  pending_any_confirmation do
    if confirmation_period_expired?
      self.errors.add(:email, :confirmation_period_expired,
        period: Devise::TimeInflector.time_ago_in_words(self.class.confirm_within.ago))
      return false
    end

    self.confirmed_at = Time.now.utc

    saved = if pending_reconfirmation?
      skip_reconfirmation!
      self.email = unconfirmed_email
      self.unconfirmed_email = nil

      # We need to validate in such cases to enforce e-mail uniqueness
      save(validate: true)
    else
      save(validate: args[:ensure_valid] == true)
    end

    after_confirmation if saved
    saved
  end
end
```


## **confirmation_period_expired?**⇒ Boolean (protected)

トークンが無効になる前に、ユーザーの確認が行われるかどうかを判定する。confirm_withinがnilの場合は常にfalseが返る。

設定と実際の例

```
# confirm_within = 3.days and confirmation_sent_at = 2.days.ago
confirmation_period_expired?  # returns false

# confirm_within = 3.days and confirmation_sent_at = 4.days.ago
confirmation_period_expired?  # returns true

# confirm_within = nil
confirmation_period_expired?  # will always return false
```

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L232){:target="_blank"}

定義はこちら

```
def confirmation_period_expired?
  self.class.confirm_within && self.confirmation_sent_at && (Time.now.utc > self.confirmation_sent_at.utc + self.class.confirm_within)
end
```

## **confirmation_period_valid?** ⇒ Boolean (protected)

確認処理が制限期間内であるかどうかを検証する。
確認した時の時間と送信日の差を設定された確認時間と比べて計算する。
config/initializers/devise.rbの
`config.allow_unconfirmed_access_for = 2.days`をコメントアウトして設定する。

設定と実際の例

```
# allow_unconfirmed_access_for = 1.day and confirmation_sent_at = today
confirmation_period_valid?   # returns true

# allow_unconfirmed_access_for = 5.days and confirmation_sent_at = 4.days.ago
confirmation_period_valid?   # returns true

# allow_unconfirmed_access_for = 5.days and confirmation_sent_at = 5.days.ago
confirmation_period_valid?   # returns false

# allow_unconfirmed_access_for = 0.days
confirmation_period_valid?   # will always return false

# allow_unconfirmed_access_for = nil
confirmation_period_valid?   # will always return true
```

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L213){:target="_blank"}

```
def confirmation_period_valid?
  return true if self.class.allow_unconfirmed_access_for.nil?
  return false if self.class.allow_unconfirmed_access_for == 0.days

  confirmation_sent_at && confirmation_sent_at.utc >= self.class.allow_unconfirmed_access_for.ago
end
```

## **confirmed?** ⇒ Boolean
確認済みであるかどうかを検証する。実際にはconfirmed_atに値が入っているかどうかを検証する。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L106){:target="_blank"}

```
def confirmed?
  !!confirmed_at
end
```

## **generate_confirmation_token** ⇒ Object (protected)
検証用のランダムトークンを設定する。また、この生成時に`confirmation_sent_at`に現在時刻を設定する。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L248){:target="_blank"}

```
def generate_confirmation_token
  if self.confirmation_token && !confirmation_period_expired?
    @raw_confirmation_token = self.confirmation_token
  else
    self.confirmation_token = @raw_confirmation_token = Devise.friendly_token
    self.confirmation_sent_at = Time.now.utc
  end
end
```
## **generate_confirmation_token!** ⇒ Object (protected)

`generate_confirmation_token`を実行し、バリデーションなしで更新処理を行う。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L257){:target="_blank"}

```
def generate_confirmation_token!
  generate_confirmation_token && save(validate: false)
end
```
## **inactive_message** ⇒ Object

アカウントが有効化されていない場合にメッセージを表示する。

localeファイルの`unconfirmed`をカスタマイズすることで文言変更可能。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L149){:target="_blank"}

```
def inactive_message
  !confirmed? ? :unconfirmed : super
end
```

## **pending_reconfirmation** ⇒ Object (protected)

レシーバーオブジェクトに対して検証が必要か確認する。確認済みであればemaiフィールドにalready_confirmedで定義されたエラーメッセージを加え、falseを返す。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L237){:target="_blank"}

```
def pending_any_confirmation
  if (!confirmed? || pending_reconfirmation?)
    yield
  else
    self.errors.add(:email, :already_confirmed)
    false
  end
end
```

## **pending_reconfirmation?** ⇒ Boolean

レシーバーが確認メールに未対応かどうかをBoolean型で返却する。recomfirmableをレシーバーのクラスが使用できるかどうかという点と、unconfirmed_emailに値が入っているかどうかをチェックする。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L110){:target="_blank"}

```
def pending_reconfirmation?
  self.class.reconfirmable && unconfirmed_email.present?
end
```

## **resend_confirmation_instructions**⇒ Object
トークンを再送信する。もし、トークンが期限切れであれば再生成する。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L134){:target="_blank"}

```
def resend_confirmation_instructions
  pending_any_confirmation do
    send_confirmation_instructions
  end
end
```

## **send_confirmation_instructions** ⇒ Object

`resend_confirmation_instructions`の中でも使われている。トークンを設定して確認用のメールを送っている実体。

[View on GitHub](https://github.com/heartcombo/devise/blob/master/lib/devise/models/confirmable.rb#L115){:target="_blank"}

```
def send_confirmation_instructions
  unless @raw_confirmation_token
    generate_confirmation_token!
  end

  opts = pending_reconfirmation? ? { to: unconfirmed_email } : { }
  send_devise_notification(:confirmation_instructions, @raw_confirmation_token, opts)
end
```
## send_reconfirmation_instructions ⇒ Object
